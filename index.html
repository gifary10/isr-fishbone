<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#fa800c" />
    <meta name="description" content="Alat analisis Fishbone untuk identifikasi akar penyebab masalah">
    <title>Fishbone Analysis Tool</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/main.css">
</head>
<body>
    <header class="app-header" style="background: linear-gradient(180deg, #fa800c, #d32f2f);">
        <h2 class="app-title">
            <i class="fas fa-fish" aria-hidden="true"></i> Fishbone Analysis
        </h2>
    </header>
    
    <div class="container">
        <div class="row g-2">
            <!-- Manusia Card -->
            <div class="col-12 col-sm-6">
                <div class="card category-card fade-in" id="man-card">
                    <div class="card-header text-light category-header category-man">
                        <i class="fas fa-users category-icon"></i>
                        <span>Manusia</span>
                        <span class="category-counter" id="man-counter">0</span>
                    </div>
                    <div class="card-body category-body">
                        <div class="input-group">
                            <select class="form-select" id="man-cause" aria-label="Pilih penyebab manusia">
                                <option value="">Pilih penyebab...</option>
                            </select>
                            <button class="btn btn-primary btn-icon" id="add-man-cause" title="Tambah" aria-label="Tambah penyebab manusia">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div id="man-causes-list" class="cause-list mt-2">
                            <div class="empty-state">Belum ada penyebab ditambahkan</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Metode Card -->
            <div class="col-12 col-sm-6">
                <div class="card category-card fade-in" id="method-card" style="animation-delay: 0.1s">
                    <div class="card-header text-light category-header category-method">
                        <i class="fas fa-project-diagram category-icon"></i>
                        <span>Metode</span>
                        <span class="category-counter" id="method-counter">0</span>
                    </div>
                    <div class="card-body category-body">
                        <div class="input-group">
                            <select class="form-select" id="method-cause" aria-label="Pilih penyebab metode">
                                <option value="">Pilih penyebab...</option>
                            </select>
                            <button class="btn btn-info text-white btn-icon" id="add-method-cause" title="Tambah" aria-label="Tambah penyebab metode">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div id="method-causes-list" class="cause-list mt-2">
                            <div class="empty-state">Belum ada penyebab ditambahkan</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Mesin Card -->
            <div class="col-12 col-sm-6">
                <div class="card category-card fade-in" id="machine-card" style="animation-delay: 0.2s">
                    <div class="card-header text-light category-header category-machine">
                        <i class="fas fa-cogs category-icon"></i>
                        <span>Mesin</span>
                        <span class="category-counter" id="machine-counter">0</span>
                    </div>
                    <div class="card-body category-body">
                        <div class="input-group">
                            <select class="form-select" id="machine-cause" aria-label="Pilih penyebab mesin">
                                <option value="">Pilih penyebab...</option>
                            </select>
                            <button class="btn btn-warning btn-icon" id="add-machine-cause" title="Tambah" aria-label="Tambah penyebab mesin">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div id="machine-causes-list" class="cause-list mt-2">
                            <div class="empty-state">Belum ada penyebab ditambahkan</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Pengukuran Card -->
            <div class="col-12 col-sm-6">
                <div class="card category-card fade-in" id="measurement-card" style="animation-delay: 0.3s">
                    <div class="card-header text-light category-header category-measurement">
                        <i class="fas fa-ruler-combined category-icon"></i>
                        <span>Pengukuran</span>
                        <span class="category-counter" id="measurement-counter">0</span>
                    </div>
                    <div class="card-body category-body">
                        <div class="input-group">
                            <select class="form-select" id="measurement-cause" aria-label="Pilih penyebab pengukuran">
                                <option value="">Pilih penyebab...</option>
                            </select>
                            <button class="btn btn-success btn-icon" id="add-measurement-cause" title="Tambah" aria-label="Tambah penyebab pengukuran">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div id="measurement-causes-list" class="cause-list mt-2">
                            <div class="empty-state">Belum ada penyebab ditambahkan</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Material Card -->
            <div class="col-12 col-sm-6">
                <div class="card category-card fade-in" id="material-card" style="animation-delay: 0.4s">
                    <div class="card-header text-light category-header category-material">
                        <i class="fas fa-boxes category-icon"></i>
                        <span>Material</span>
                        <span class="category-counter" id="material-counter">0</span>
                    </div>
                    <div class="card-body category-body">
                        <div class="input-group">
                            <select class="form-select" id="material-cause" aria-label="Pilih penyebab material">
                                <option value="">Pilih penyebab...</option>
                            </select>
                            <button class="btn btn-danger btn-icon" id="add-material-cause" title="Tambah" aria-label="Tambah penyebab material">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div id="material-causes-list" class="cause-list mt-2">
                            <div class="empty-state">Belum ada penyebab ditambahkan</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Lingkungan Card -->
            <div class="col-12 col-sm-6">
                <div class="card category-card fade-in" id="mothernature-card" style="animation-delay: 0.5s">
                    <div class="card-header text-light category-header category-mothernature">
                        <i class="fas fa-leaf category-icon"></i>
                        <span>Lingkungan</span>
                        <span class="category-counter" id="mothernature-counter">0</span>
                    </div>
                    <div class="card-body category-body">
                        <div class="input-group">
                            <select class="form-select" id="mothernature-cause" aria-label="Pilih penyebab lingkungan">
                                <option value="">Pilih penyebab...</option>
                            </select>
                            <button class="btn btn-secondary btn-icon" id="add-mothernature-cause" title="Tambah" aria-label="Tambah penyebab lingkungan">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div id="mothernature-causes-list" class="cause-list mt-2">
                            <div class="empty-state">Belum ada penyebab ditambahkan</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tombol Analisis di bawah -->
<button class="btn btn-primary w-100 fixed-bottom" id="analyze-btn" style="z-index: 999;">
    <i class="fas fa-chart-bar"></i> Analisis
</button>

<!-- Tombol bantuan mengambang di atas tombol analisis -->
<div class="fixed-action-buttons" >
    <button class="btn btn-floating help-btn" id="help-btn">
        <i class="fas fa-question-circle"></i>
    </button>
</div>
<!-- Add this to index.html -->
<script src="assets/auth-redirect.js"></script>
    <!-- JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Fishbone Info Modal -->
    <script src="fishbone.js"></script>
    
    <script type="module">
        // Import semua sumber data dengan benar
        import humanFactors from './sources/man.js';
        import methodFactors from './sources/method.js';
        import machineFactors from './sources/machine.js';
        import measurementFactors from './sources/measurement.js';
        import materialFactors from './sources/material.js';
        import environmentFactors from './sources/mothernature.js';

        // Konfigurasi kategori dengan akses ke items
        const CATEGORIES = {
            'man': {
                name: 'Manusia',
                color: 'primary',
                icon: 'fas fa-users',
                data: humanFactors.items
            },
            'method': {
                name: 'Metode',
                color: 'info',
                icon: 'fas fa-project-diagram',
                data: methodFactors.items
            },
            'machine': {
                name: 'Mesin',
                color: 'warning',
                icon: 'fas fa-cogs',
                data: machineFactors.items
            },
            'measurement': {
                name: 'Pengukuran',
                color: 'success',
                icon: 'fas fa-ruler-combined',
                data: measurementFactors.items
            },
            'material': {
                name: 'Material',
                color: 'danger',
                icon: 'fas fa-boxes',
                data: materialFactors.items
            },
            'mothernature': {
                name: 'Lingkungan',
                color: 'secondary',
                icon: 'fas fa-leaf',
                data: environmentFactors.items
            }
        };

        // Inisialisasi aplikasi
        class FishboneApp {
            constructor() {
                this.selectedCauses = {};
                this.initDropdowns();
                this.setupEventListeners();
                this.updateCounters();
            }

            initDropdowns() {
                for (const [categoryId, category] of Object.entries(CATEGORIES)) {
                    const select = document.getElementById(`${categoryId}-cause`);
                    
                    // Kosongkan dropdown kecuali opsi pertama
                    select.innerHTML = '<option value="">Pilih penyebab...</option>';
                    
                    // Tambahkan semua item tanpa filter
                    category.data.forEach(item => {
                        const option = new Option(item.cause, item.id);
                        option.dataset.description = item.description;
                        option.dataset.solutions = JSON.stringify(item.solutions || []);
                        option.dataset.priority = item.priority || 'Medium';
                        select.add(option);
                    });
                }
            }

            setupEventListeners() {
                // Tombol tambah penyebab
                for (const categoryId in CATEGORIES) {
                    document.getElementById(`add-${categoryId}-cause`).addEventListener('click', () => {
                        this.addCause(categoryId);
                    });

                    // Juga aktifkan dengan Enter
                    document.getElementById(`${categoryId}-cause`).addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            this.addCause(categoryId);
                        }
                    });
                }

                // Tombol analisis
                document.getElementById('analyze-btn').addEventListener('click', () => {
                    this.analyze();
                });
                
                // Tombol bantuan
                document.getElementById('help-btn').addEventListener('click', () => {
                    const modal = new bootstrap.Modal(document.getElementById('fishboneModal'));
                    modal.show();
                });
            }

            addCause(categoryId) {
                const select = document.getElementById(`${categoryId}-cause`);
                const selectedOption = select.options[select.selectedIndex];
                
                if (!selectedOption.value) {
                    this.showAlert('Silakan pilih penyebab terlebih dahulu!');
                    return;
                }

                const list = document.getElementById(`${categoryId}-causes-list`);
                const emptyState = list.querySelector('.empty-state');
                
                if (emptyState) {
                    list.removeChild(emptyState);
                }

                // Cek duplikasi
                if (document.querySelector(`#${categoryId}-causes-list [data-id="${selectedOption.value}"]`)) {
                    this.showAlert('Penyebab ini sudah ditambahkan!');
                    return;
                }

                // Buat elemen baru
                const causeItem = document.createElement('div');
                causeItem.className = `cause-item priority-${(selectedOption.dataset.priority || 'medium').toLowerCase()}`;
                causeItem.dataset.id = selectedOption.value;
                causeItem.dataset.category = categoryId;
                
                // Buat badge prioritas
                const priorityBadge = selectedOption.dataset.priority 
                    ? `<span class="badge priority-badge bg-${this.getPriorityColor(selectedOption.dataset.priority)}">
                        ${selectedOption.dataset.priority}
                       </span>` 
                    : '';
                
                causeItem.innerHTML = `
                    <div class="cause-header d-flex justify-content-between align-items-center">
                        <span class="cause-text">${selectedOption.text} ${priorityBadge}</span>
                        <button class="btn btn-sm btn-link text-danger remove-btn p-0" aria-label="Hapus penyebab">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;

                // Tombol hapus
                causeItem.querySelector('.remove-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    causeItem.remove();
                    if (list.children.length === 0) {
                        list.innerHTML = '<div class="empty-state">Belum ada penyebab ditambahkan</div>';
                    }
                    this.updateCounters();
                });

                // Animasi tambah
                $(causeItem).hide().fadeIn(300);
                list.appendChild(causeItem);
                select.value = '';
                
                this.updateCounters();
            }
            
            updateCounters() {
                for (const categoryId in CATEGORIES) {
                    const counter = document.getElementById(`${categoryId}-counter`);
                    const list = document.getElementById(`${categoryId}-causes-list`);
                    const items = list.querySelectorAll('.cause-item');
                    counter.textContent = items.length;
                }
            }
            
            getPriorityColor(priority) {
                if (!priority) return 'secondary';
                priority = priority.toLowerCase();
                if (priority.includes('critical')) return 'danger';
                if (priority.includes('high')) return 'warning';
                if (priority.includes('medium')) return 'info';
                return 'success';
            }

            analyze() {
                this.collectSelectedCauses();
                
                if (Object.keys(this.selectedCauses).length === 0) {
                    this.showAlert('Silakan tambahkan minimal satu penyebab!');
                    return;
                }

                // Simpan ke session storage dengan format yang benar
                sessionStorage.setItem('fishboneAnalysis', JSON.stringify({
                    selected: this.selectedCauses,
                    categories: Object.keys(CATEGORIES).reduce((acc, cat) => {
                        acc[cat] = CATEGORIES[cat].name;
                        return acc;
                    }, {})
                }));

                // Redirect ke hasil
                window.location.href = 'hasil.html';
            }

            collectSelectedCauses() {
                this.selectedCauses = {};
                
                for (const categoryId in CATEGORIES) {
                    const items = [];
                    document.querySelectorAll(`#${categoryId}-causes-list .cause-item`).forEach(item => {
                        items.push(item.dataset.id);
                    });
                    
                    if (items.length > 0) {
                        this.selectedCauses[categoryId] = items;
                    }
                }
            }

            showAlert(message) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-warning alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
                alertDiv.style.zIndex = '1100';
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                document.body.appendChild(alertDiv);
                
                // Auto dismiss after 3 seconds
                setTimeout(() => {
                    alertDiv.classList.remove('show');
                    setTimeout(() => alertDiv.remove(), 150);
                }, 3000);
            }
        }

        // Jalankan aplikasi saat DOM siap
        document.addEventListener('DOMContentLoaded', () => {
            new FishboneApp();
        });
    </script>
</body>
</html>